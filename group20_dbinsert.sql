-- Create all relations into tables
CREATE TABLE Students (
    studID INTEGER,
    name VARCHAR(10),
    major VARCHAR(4),
    gender VARCHAR(1),
    PRIMARY KEY(studID)
   )
	
CREATE TABLE Books(
    call_No VARCHAR(5),
    ISBN varchar(15),
    title VARCHAR(2),
    author VARCHAR(2),
    location VARCHAR(5),
    amount INTEGER,
    PRIMARY KEY (call_No)
)

CREATE TABLE Renew_Book (
	StudID INTEGER,
    call_No VARCHAR(5),
    ISBN varchar(15),
    title VARCHAR(2),
    author VARCHAR(2),
    location VARCHAR(5),
    amount INTEGER,
    PRIMARY KEY(call_No)
)

CREATE TABLE Reserved( 
	call_No varchar(5),
    studID INTEGER,
    name VARCHAR(5),
    major VARCHAR(4),
    gender VARCHAR(1),
    request_date Date, 
    PRIMARY KEY (studID)
)

CREATE TABLE Borrow(
    studID INTEGER,
    call_No VARCHAR(5),
    borrow_date  DATE, 
    due_date DATE,
    PRIMARY KEY (studID, call_No)
)

--Adding Foreign Keys
-- --(if needed)ALTER TABLE Renew_Book DROP CONSTRAINT stud_CONST 

ALTER TABLE Renew_Book ADD CONSTRAINT stud_CONST 
FOREIGN KEY (StudID) REFERENCES Students(StudID);

-- --(if needed) ALTER TABLE Renew_Book DROP CONSTRAINT book_CONST

ALTER TABLE Reserved ADD CONSTRAINT book_CONST 
FOREIGN KEY (call_No) REFERENCES Books(call_No);

-- --(if needed) ALTER TABLE Borrow DROP CONSTRAINT stud_CONST1
ALTER TABLE Borrow ADD CONSTRAINT stud_CONST1 
FOREIGN KEY (StudID) REFERENCES Students(StudID); 

-- --(if needed) ALTER TABLE Borrow DROP CONSTRAINT book_CONST1
ALTER TABLE Borrow ADD CONSTRAINT book_CONST1
FOREIGN KEY (call_No) REFERENCES Books(call_No);

COMMIT;

--Insert records
PROMPT INSERT BOOKS TABLE;

INSERT INTO BOOKS VALUES('A0000','0-306-40615-1','AA','XX','S1E01',0);
INSERT INTO BOOKS VALUES('B0000','0-306-40615-2','BB','YY','S2E02',0);
INSERT INTO BOOKS VALUES('C1111','0-306-40615-3','CC','ZZ','D1E11',2);
INSERT INTO BOOKS VALUES('B0001','0-306-40615-4','DD','UU','G1E00',2);
INSERT INTO BOOKS VALUES('A1111','0-306-40615-5','EE','VV','B1E00',2);
INSERT INTO BOOKS VALUES('D0101','0-306-40615-6','FF','WW','B2E11',1);
INSERT INTO BOOKS VALUES('E0000','0-306-40615-7','GG','PP','X0E22',0);
INSERT INTO BOOKS VALUES('E0100','0-306-40615-8','HH','QQ','X0E21',2);
INSERT INTO BOOKS VALUES('E0111','0-306-40615-9','II','RR','X0E44',0);


PROMPT INSERT Students TABLE;
INSERT INTO Students VALUES(12345678,'A','Comp','M');
INSERT INTO Students VALUES(11111111,'B','Math','M');
INSERT INTO Students VALUES(22222222,'C','Comm','F');
INSERT INTO Students VALUES(33333333,'D','Comm','F');
INSERT INTO Students VALUES(44444444,'E','Comp','M');
INSERT INTO Students VALUES(55555555,'F','Comm','M');
INSERT INTO Students VALUES(66666666,'G','Math','F');
INSERT INTO Students VALUES(77777777,'H','Comp','M');

PROMPT INSERT BORROW TABLE;
INSERT INTO BORROW VALUES(11111111,'D0101','24-MAR-2022','21-APR-2022');
INSERT INTO BORROW VALUES(55555555,'A1111','23-MAR-2022','20-APR-2022');
INSERT INTO BORROW VALUES(22222222,'B0000','31-MAR-2022','12-MAY-2022');
INSERT INTO BORROW VALUES(11111111,'A0000','1-APR-2022','29-APR-2022');
INSERT INTO BORROW VALUES(33333333,'A0000','3-APR-2022','1-MAY-2022');
INSERT INTO BORROW VALUES(11111111,'B0000','3-APR-2022','15-MAY-2022');
INSERT INTO BORROW VALUES(44444444,'C1111','4-APR-2022','16-MAY-2022');
INSERT INTO BORROW VALUES(44444444,'A0000','6-APR-2022','4-MAY-2022');

INSERT INTO BORROW VALUES(33333333,'C1111','6-APR-2022','4-MAY-2022');
INSERT INTO BORROW VALUES(33333333,'A1111','6-APR-2022','4-MAY-2022');
INSERT INTO BORROW VALUES(33333333,'B0001','6-APR-2022','4-MAY-2022');
INSERT INTO BORROW VALUES(44444444,'D0101','10-APR-2022','8-MAY-2022');
INSERT INTO BORROW VALUES(33333333,'D0101','10-APR-2022','8-MAY-2022');
INSERT INTO BORROW VALUES(44444444,'A1111','14-APR-2022','12-MAY-2022');
INSERT INTO BORROW VALUES(55555555,'C1111','18-APR-2022','16-MAY-2022');
INSERT INTO BORROW VALUES(22222222,'E0111','19-APR-2022','17-MAY-2022');
INSERT INTO BORROW VALUES(11111111,'E0000','20-APR-2022','18-MAY-2022');
INSERT INTO BORROW VALUES(44444444,'B0001','21-APR-2022','19-MAY-2022');

PROMPT INSERT RESERVED TABLE;
INSERT INTO Reserved (studID,call_No, request_date) Values('12345678','A0000','20-APR-22');
INSERT INTO Reserved (studID,call_No, request_date) Values('66666666','E0000','22-APR-22');

PROMPT INSERT Renew_book TABLE;
INSERT INTO Renew_book (studID,call_No) Values('22222222','B0000');
INSERT INTO Renew_book (studID,call_No) Values('11111111','B0000');
INSERT INTO Renew_book (studID,call_No) Values('12345678','C1111');



-- Borrow Trigger 
CREATE OR REPLACE TRIGGER BORROW_BOOK
AFTER INSERT OR UPDATE ON Borrow
FOR EACH ROW
DECLARE 
    cnt INTEGER; 
BEGIN
    SELECT Amount INTO cnt FROM Books 
    WHERE call_No = :new.call_No;
    cnt := cnt - 1;
    UPDATE Books 
    SET Amount = cnt 
        WHERE call_No = :new.call_No;
END;
/


-- Return Trigger 
CREATE OR REPLACE TRIGGER RETURN_BOOK
AFTER DELETE OR UPDATE ON Borrow
FOR EACH ROW
DECLARE 
    cnt INTEGER; 
BEGIN
    SELECT Amount INTO cnt FROM Books 
    WHERE call_No = :old.call_No;
    cnt := cnt + 1;
    UPDATE Books 
    SET Amount = cnt 
        WHERE call_No = :old.call_No;
END;
/

COMMIT;
SET AUTOCOMMIT ON


